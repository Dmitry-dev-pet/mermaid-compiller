Цель: реализовать окно эволюции диаграммы, где структурный шаг запускается кнопкой «Эволюционировать», стилизация остаётся отдельным действием, валидация запускается скриптом автоматически, а полный текст промптов и Context7-запросов показывается через маленькие кнопки, открывающие отдельные модальные окна.

1. Общий UX
   • Основной экран: поле промпта и кнопка «Эволюционировать» (структура), ниже список итераций (таймлайн) с кратким саммари. Стилизация вызывается кнопкой «Стилизовать» внутри карточки итерации. Никаких переключателей Structure/Style/Fixes.  
   • Справа — превью диаграммы, всегда показывающее последнюю валидную версию выбранной итерации.  
   • В каждой карточке итерации присутствуют две маленькие кнопки: «Промпт» и «Context7». При нажатии открывается отдельное модальное окно (overlay) с соответствующей полной информацией; закрытие — по крестику.

2. Поток
   • «Эволюционировать» → (a) всегда вызывает новый Context7 запрос (независимо от уточнений), (b) запускает LLM для структуры. После каждого ответа автоматически работает `validateMermaidCode`; если ошибка — скрипт создает стадию фикса и повторяет до лимита.  
   • Структура валидна → карточка итерации показывает бейдж «Structure OK», кнопка «Стилизовать» активна.  
   • «Стилизовать» выполняет отдельный LLM вызов; проверка и автофиксы идут автоматически; успешный результат становится текущим кодом итерации.  
   • Уточнение промпта просто создает новую итерацию, процедура повторяется. Все данные (включая промпты и контекст) сохраняются внутри итерации.

3. Данные
   • Итерация: {id, prompt, diagramType, context7:{rawQuery, normalizedQuery, stylePrefs, snippets}, stages:[{type:"structure"|"fix"|"style", prompts:{system,user}, assistantRaw, code, validation}], activeCode}.  
   • `activeCode` = последний валидный код этой итерации.  
   • Для модальных окон храним подготовленные HTML-тексты/JSON, чтобы показать пользователю.

4. UI модальных окон
   • Общий компонент «modal» с заголовком и большим `pre`/`code` блоком.  
   • Кнопка «Промпт» открывает модалку с system/user/assistant текстами всех стадий выбранной итерации.  
   • Кнопка «Context7» открывает нормализованный запрос: исходный текст, `search_query`, `style_prefs`, массив snippets.  
   • Окно закрывается по крестику или Esc, при закрытии фокус возвращается к кнопке.

5. Технические шаги
   • Обновить `public/index.html`: новая структура карточек итераций, мини-кнопки (например, иконки «ⓘ»), верстка модального окна.  
   • Рефактор `public/app.js`: новые структуры данных, автоматический Context7 вызов и валидация, логика показа/скрытия модалок (без перерендера всей страницы).  
   • Удалить кнопки Structure/Style/Fixes, оставить «Эволюционировать» + «Стилизовать» (по запросу).  
   • Обновить CSS под таймлайн, бейджи стадий и модальные окна.

После подтверждения начинаю реализацию по этому плану.