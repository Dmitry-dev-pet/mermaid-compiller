# Генератор Диаграмм Mermaid с Интеграцией cliproxyapi

## 1. Введение

Данная спецификация описывает функциональность веб-инструмента, который позволяет пользователям создавать и итеративно улучшать диаграммы Mermaid с помощью текстовых промптов на естественном языке. Система использует локальный прокси для Больших Языковых Моделей (LLM), `cliproxyapi`, запущенный на компьютере пользователя для управления взаимодействием с LLM и использованием токенов.

## 2. Цели

*   Предоставить пользователям возможность создавать диаграммы Mermaid, используя описательные текстовые промпты.
*   Поддерживать итеративное улучшение сгенерированных диаграмм с помощью последующих промптов.
*   Обеспечить немедленную визуальную обратную связь для диаграмм Mermaid.
*   Использовать `cliproxyapi` для безопасного управления токенами LLM на основе подписки.
*   Гарантировать, что сгенерированные диаграммы Mermaid являются синтаксически и структурно корректными.

## 3. Функциональные Требования

### ФТ-001: Генерация диаграмм на основе промптов
*   **Описание:** Пользователь должен иметь возможность вводить промпт на естественном языке (например, "Создай блок-схему для заказа кофе").
*   **Входные данные:** Текстовый промпт от пользователя.
*   **Выходные данные:** Визуальное представление сгенерированной диаграммы Mermaid и её соответствующий код.

### ФТ-002: Итеративное улучшение диаграмм
*   **Описание:** Пользователь должен иметь возможность предоставлять последующие промпты для изменения текущей отображаемой диаграммы Mermaid (например, "Добавь узел принятия решения 'Хотите молоко?' после 'Сварить кофе'").
*   **Входные данные:** Новый текстовый промпт, текущий код диаграммы Mermaid.
*   **Выходные данные:** Обновленное визуальное представление и код Mermaid, включающий изменения.

### ФТ-003: Локальная интеграция с LLM через cliproxyapi
*   **Описание:** Всё взаимодействие с базовой Большой Языковой Моделью для генерации и исправления диаграмм должно маршрутизироваться через локальный экземпляр `cliproxyapi`, запущенный на компьютере пользователя.
*   **Зависимость:** Требуется, чтобы `cliproxyapi` был запущен локально на системе пользователя.
*   **Аутентификация:** `cliproxyapi` будет обрабатывать аутентификацию и управление токенами для LLM на основе подписки пользователя.

### ФТ-004: Валидация диаграмм на стороне клиента
*   **Описание:** После каждой попытки генерации или улучшения со стороны LLM, сгенерированный код Mermaid должен проходить валидацию в браузере пользователя на синтаксическую и структурную корректность.
*   **Правила валидации:** Начальные правила будут включать:
    *   Синтаксическая корректность согласно Mermaid.js.
    *   Базовые структурные проверки (например, наличие начального/конечного узла, если это применимо для типа диаграммы).
*   **Поведение при сбое:** Если валидация не пройдена, будет запущен автоматический процесс исправления (ФТ-005).

### ФТ-005: Автоматический цикл исправления диаграмм
*   **Описание:** Если LLM генерирует невалидную диаграмму Mermaid, клиентское приложение должно автоматически попытаться её исправить, отправив специальный корректирующий промпт обратно в LLM (через `cliproxyapi`).
*   **Корректирующий промпт:** Корректирующий промпт будет включать:
    *   Оригинальный промпт пользователя.
    *   Некорректный код Mermaid, сгенерированный LLM.
    *   Конкретные ошибки валидации, выявленные в ФТ-004.
*   **Механизм повторных попыток:** Система должна предпринять максимум 2-3 попытки исправления. Если диаграмма остаётся невалидной после этих попыток, пользователь будет проинформирован о неудаче.

### ФТ-006: Отображение визуализации и кода
*   **Описание:** Пользовательский интерфейс должен одновременно отображать как визуальное представление диаграммы Mermaid, так и её исходный код.
*   **Обратная связь:** Предоставляет чёткую обратную связь об успешной генерации, текущих попытках исправления и окончательных сбоях.

## 4. Нефункциональные Требования

### НФТ-001: Производительность (Отзывчивость)
*   Приложение должно предоставлять своевременную обратную связь пользователю, при этом попытки генерации и исправления диаграмм должны завершаться в разумные сроки (в зависимости от производительности LLM и локального прокси).

### НФТ-002: Удобство использования
*   Пользовательский интерфейс должен быть интуитивно понятным и простым в использовании для ввода промптов и просмотра результатов.

### НФТ-003: Модульность
*   Код должен быть структурирован модульно, что позволяет легко обновлять правила валидации, стратегии промптинга для LLM и компоненты пользовательского интерфейса.
