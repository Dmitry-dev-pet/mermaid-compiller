# Генератор Диаграмм Mermaid с Интеграцией cliproxyapi (React/Vite)

## 1. Введение

Данная спецификация описывает функциональность веб-инструмента (SPA), который позволяет пользователям создавать и итеративно улучшать диаграммы Mermaid с помощью текстовых промптов. Система построена на стеке React + Vite + TypeScript и использует локальный прокси (`cliproxyapi`) или OpenRouter для взаимодействия с LLM.

## 2. Цели

*   Создание диаграмм Mermaid по текстовому описанию.
*   Итеративное улучшение диаграмм (чат-режим).
*   Мгновенная визуализация и валидация.
*   Безопасное управление ключами LLM (хранение в браузере).
*   Автоматическое исправление ошибок синтаксиса Mermaid.
*   Современный и отзывчивый UI.

## 3. Функциональные Требования

### ФТ-001: Генерация диаграмм на основе промптов
*   **Вход:** Текстовый промпт в `ChatColumn` + явное действие пользователя (**Chat** или **Build**).
*   **Процесс (Build):** Запрос к LLM (`generateDiagram`) с контекстом документации (`docsContextService`) и историей чата; Build может запускаться без нового промпта, используя только контекст чата -> извлечение Mermaid кода -> валидация.
*   **Процесс (Chat):** Запрос к LLM (`chat`) для текстового ответа/уточнений, без применения Mermaid кода в редактор.
*   **Выход:** Код Mermaid в `EditorColumn` и SVG в `PreviewColumn`.

### ФТ-002: Итеративное улучшение диаграмм
*   **Вход:** Новый промпт + история чата + текущий код.
*   **Процесс:** LLM получает контекст и возвращает модифицированный код.
*   **Выход:** Обновленная диаграмма.

### ФТ-003: Интеграция с LLM
*   **Поддержка:** `cliproxyapi` (локально) и OpenRouter.
*   **Конфигурация:** Пользователь задает URL/Key в `Header`.
*   **Модели:** Получение списка доступных моделей, фильтрация.

### ФТ-004: Валидация диаграмм
*   **Механизм:** `mermaid.parse()` на клиенте.
*   **Реакция:**
    *   Успех: Рендер диаграммы.
    *   Ошибка: Подсветка строки с ошибкой в редакторе, сообщение об ошибке.

### ФТ-005: Автоматический цикл исправления
*   **Триггер:** Кнопка "Fix Syntax" и автоматически после **Build**, если сгенерированный код невалиден (до N попыток).
*   **Данные:** Текущий код + текст ошибки парсера.
*   **Действие:** Запрос к LLM на исправление.

### ФТ-006: Редактор кода
*   **Функции:** Подсветка синтаксиса Mermaid (PrismJS + кастомная грамматика), номера строк, поддержка темной темы (One Dark), копирование в буфер.
*   **Синхронизация:** Изменения в редакторе немедленно обновляют стейт (для плавности курсора), валидация и превью выполняются асинхронно.

### ФТ-007: Интеграция с документацией
*   **Бэкенд:** Эндпоинт `/mermaid-docs` (раздача статики).
*   **Фронтенд:** `docsContextService` загружает нужные части документации (параллельно) в зависимости от типа диаграммы и добавляет их в System Prompt.

### ФТ-008: Мультиязычность
*   **Авто-определение:** Система определяет язык пользователя (RU/EN) по первому сообщению.
*   **Ручной выбор:** Возможность переключения языка через UI.
*   **Адаптация:** Промпты для LLM адаптируются под выбранный язык.

## 4. Нефункциональные Требования

### НФТ-001: Производительность
*   SPA архитектура (Vite) для мгновенной загрузки страниц.
*   Оптимизированный рендеринг React компонентов (`useLayoutEffect` для тем, `useCallback` для хендлеров).

### НФТ-002: Удобство использования
*   Адаптивный дизайн (Tailwind CSS) с поддержкой **Dark Mode**.
*   Понятная индикация статусов (Loading, Error, Success).
*   Разделение экрана на 3 колонки (Чат, Редактор, Превью) с возможностью изменения размеров.

### НФТ-003: Архитектура
*   **Frontend:** React 19, TypeScript, Vite.
*   **State:** Custom Hook (`useDiagramStudio.ts`) для централизованного управления состоянием и логикой.
*   **Services:** Выделенные сервисы для бизнес-логики (`llmService`, `mermaidService`, `docsContextService`).
*   **Patterns:** Strategy Pattern для поддержки различных LLM провайдеров (`OpenRouterStrategy`, `CliproxyStrategy`).

### НФТ-004: Технологический стек
*   **Язык:** TypeScript.
*   **Сборщик:** Vite.
*   **Стили:** Tailwind CSS.
*   **Иконки:** Lucide React.
*   **Редактор:** `react-simple-code-editor` + `prismjs`.
*   **Диаграммы:** Mermaid.js (npm).
