# Генератор Диаграмм Mermaid с Интеграцией cliproxyapi (React/Vite)

## 1. Введение

Данная спецификация описывает функциональность веб-инструмента (SPA), который позволяет пользователям создавать и итеративно улучшать диаграммы Mermaid с помощью текстовых промптов. Система построена на стеке React + Vite + TypeScript и использует локальный прокси (`cliproxyapi`) или OpenRouter для взаимодействия с LLM.

## 2. Цели

*   Создание диаграмм Mermaid по текстовому описанию.
*   Итеративное улучшение диаграмм (чат-режим).
*   Мгновенная визуализация и валидация.
*   Безопасное управление ключами LLM (хранение в браузере).
*   Автоматическое исправление ошибок синтаксиса Mermaid.
*   Современный и отзывчивый UI.
*   Поддержка всех типов диаграмм из актуальной документации Mermaid (v11.12.2).

## 3. Функциональные Требования

### ФТ-001: Генерация диаграмм на основе промптов
*   **Вход:** Текстовый промпт в `ChatColumn` + явное действие пользователя (**Chat** или **Build**).
*   **Процесс (Build):** Запрос к LLM (`generateDiagram`) с контекстом документации (`docsContextService`) и историей чата; Build может запускаться без нового промпта, используя только контекст чата -> извлечение Mermaid кода -> валидация.
*   **Процесс (Chat):** Запрос к LLM (`chat`) для текстового ответа/уточнений; текущий Mermaid-код (если есть) передаётся как скрытый контекст; без применения Mermaid кода в редактор.
*   **Выход:** Код Mermaid в `EditorColumn` и SVG в `PreviewColumn`.

### ФТ-002: Итеративное улучшение диаграмм
*   **Вход:** Новый промпт + история чата + текущий код.
*   **Процесс:** LLM получает контекст и возвращает модифицированный код.
*   **Выход:** Обновленная диаграмма.

### ФТ-003: Интеграция с LLM
*   **Поддержка:** `cliproxyapi` (локально) и OpenRouter.
*   **Конфигурация:** Пользователь задает URL/Key в `Header`.
*   **Модели:** Получение списка доступных моделей, фильтрация.

### ФТ-004: Валидация диаграмм
*   **Механизм:** `mermaid.parse()` на клиенте.
*   **Реакция:**
    *   Успех: Рендер диаграммы.
    *   Ошибка: Подсветка строки с ошибкой в редакторе, сообщение об ошибке.

### ФТ-005: Автоматический цикл исправления
*   **Триггер:** Кнопка "Fix Syntax" и автоматически после **Build**, если сгенерированный код невалиден (до N попыток).
*   **Данные:** Текущий код + текст ошибки парсера.
*   **Действие:** Запрос к LLM на исправление.

### ФТ-006: Редактор кода
*   **Функции:** Подсветка синтаксиса Mermaid (PrismJS + кастомная грамматика), номера строк, поддержка темной темы (One Dark), копирование в буфер.
*   **Синхронизация:** Изменения в редакторе немедленно обновляют стейт (для плавности курсора), валидация и превью выполняются асинхронно.

### ФТ-007: Интеграция с документацией
*   **Бэкенд:** Эндпоинт `/mermaid-docs` (раздача статики).
*   **Фронтенд:** `docsContextService` загружает нужные части документации (параллельно) в зависимости от типа диаграммы и добавляет их в System Prompt.

### ФТ-008: Мультиязычность
*   **Авто-определение:** Система определяет язык пользователя (RU/EN) по первому сообщению.
*   **Ручной выбор:** Возможность переключения языка через UI.
*   **Адаптация:** Промпты для LLM адаптируются под выбранный язык.

### ФТ-009: История, TimeStep и навигация по ревизиям
*   **Цель:** Сохранять историю действий и версий диаграммы и позволять навигацию по ним из UI.
*   **Сущности:**
    *   **Session:** активная сессия пользователя.
    *   **TimeStep:** шаг истории, создаётся на **любое действие** (chat/build/fix/analyze/recompile/manual_edit и т.п.).
    *   **DiagramRevision:** ревизия Mermaid-кода, создаётся только когда диаграмма меняется.
*   **Правило "одна диаграмма на шаг":** каждый `TimeStep` содержит `currentRevisionId` (ссылка на актуальную ревизию); если шаг не меняет диаграмму (например, `chat`), `currentRevisionId` копируется с предыдущего шага.
*   **Хранение:**
    *   История (`Session/TimeStep/DiagramRevision`) сохраняется в IndexedDB.
    *   Секреты/ключи не сохраняются в истории; остаются в `localStorage` как часть настроек провайдера.
*   **UI навигация:** в чате отображаются метки "отрисовка диаграммы" (шаги, где сменилась ревизия) и по клику выполняется переход к соответствующему месту в чате и переключение диаграммы на нужную ревизию.

### ФТ-010: Полный охват типов Mermaid
*   **Список типов:** все типы диаграмм из `mermaid-docs/<version>/syntax/*.md` (актуальная версия в `diagram-compiler/constants.ts`).
*   **UI:** селектор типа диаграммы показывает весь список.
*   **Контекст:** `docsContextService` загружает документацию для выбранного типа.

### ФТ-011: Управление контекстом Build-доков
*   **Триггер:** пользователь выбирает тип диаграммы или открывает вкладку Build Docs.
*   **Источник:** все Markdown-файлы, добавляемые в Build-подсказку (тип + общие разделы).
*   **Результат:** в отдельной вкладке Build Docs отображаются табы файлов с чекбоксами включения/исключения из Build-промпта.

### ФТ-012: Превью Markdown
*   **Вход:** содержимое редактора может быть Markdown.
*   **Поведение:** превью рендерит Markdown и Mermaid-блоки внутри него.

### ФТ-013: Экспорт диаграммы
*   **Форматы:** SVG (сырое) и PNG (с инлайном ресурсов).
*   **Ограничения:** PNG экспорт отменяется при `foreignObject` или при превышении лимитов встроенных ресурсов; в этих случаях показывается ошибка с рекомендацией экспортировать SVG.
*   **Параметры:** фон для PNG зависит от темы; имя файла формируется из первых токенов кода.

### ФТ-014: Превью промптов
*   **Вкладки:** в редакторе и превью отображаются отдельные вкладки для Chat и Build.
*   **Содержимое:** собранный системный промпт, список файлов документации, итоговый список сообщений и приблизительные токены (system/messages/total).
*   **Назначение:** прозрачность и отладка запросов к LLM перед отправкой.

## 4. Нефункциональные Требования

### НФТ-001: Производительность
*   SPA архитектура (Vite) для мгновенной загрузки страниц.
*   Оптимизированный рендеринг React компонентов (`useLayoutEffect` для тем, `useCallback` для хендлеров).

### НФТ-002: Удобство использования
*   Адаптивный дизайн (Tailwind CSS) с поддержкой **Dark Mode**.
*   Понятная индикация статусов (Loading, Error, Success).
*   Разделение экрана на 3 колонки (Чат, Редактор, Превью) с возможностью изменения размеров.
*   Управление превью: Zoom/Pan (drag + wheel) и кнопки Fit/Reset.
*   Навигация по истории: быстрый переход по меткам ревизий диаграммы из чата.

### НФТ-003: Архитектура
*   **Frontend:** React 19, TypeScript, Vite.
*   **State:** Custom Hook (`useDiagramStudio.ts`) для централизованного управления состоянием и логикой.
*   **Services:** Выделенные сервисы для бизнес-логики (`llmService`, `mermaidService`, `docsContextService`).
*   **Patterns:** Strategy Pattern для поддержки различных LLM провайдеров (`OpenRouterStrategy`, `CliproxyStrategy`).

### НФТ-004: Технологический стек
*   **Язык:** TypeScript.
*   **Сборщик:** Vite.
*   **Стили:** Tailwind CSS.
*   **Иконки:** Lucide React.
*   **Редактор:** `react-simple-code-editor` + `prismjs`.
*   **Диаграммы:** Mermaid.js (npm).
