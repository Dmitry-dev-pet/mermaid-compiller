# Задачи: Генератор Диаграмм Mermaid (React/Vite)

## 1. Инициализация Проекта
- [x] 1.1. Создать проект Vite + React + TypeScript.
- [x] 1.2. Настроить Tailwind CSS.
- [x] 1.3. Установить зависимости (`mermaid`, `lucide-react`, `express` и др.).
- [x] 1.4. Настроить конфигурацию Vite (proxy, alias).

## 2. Основные Компоненты UI
- [x] 2.1. **Header:** Меню настроек (URL прокси, ключ, выбор модели), статус соединения, переключение темы.
- [x] 2.2. **ChatColumn:** Список сообщений, поле ввода, выбор типа диаграммы.
- [x] 2.6. **ChatColumn:** Разделить действия на кнопки **Chat** (только текст) и **Build** (генерация диаграммы).
- [x] 2.3. **EditorColumn:** Редактор кода (PrismJS), панель инструментов, выбор языка.
- [x] 2.4. **PreviewColumn:** Рендер SVG диаграммы с использованием `mermaid.render`.
- [x] 2.5. **Resizers:** Реализовать изменение ширины колонок.

## 3. Бизнес-логика (Services & Hooks)
- [x] 3.1. **mermaidService:**
    - [x] `validateMermaid`: Парсинг и возврат ошибок.
    - [x] `extractMermaidCode`: Регулярки для извлечения кода из Markdown.
    - [x] `initializeMermaid`: Глобальный конфиг (поддержка смены темы).
- [x] 3.2. **llmService:**
    - [x] Strategy Pattern (`OpenRouterStrategy`, `CliproxyStrategy`).
    - [x] `fetchModels`: Получение списка моделей.
    - [x] `generateDiagram`, `fixDiagram`, `chat`, `analyzeDiagram`.
    - [x] Мультиязычность (поддержка `language` параметра).
- [x] 3.3. **docsContextService:**
    - [x] Параллельный фетчинг документации.
- [x] 3.4. **useDiagramStudio (Hook):**
    - [x] Централизация состояния и логики.
    - [x] `handleChatMessage` (чат: только текст).
    - [x] `handleBuildFromPrompt` (build: генерирует диаграмму из промпта).
    - [x] `handleAnalyze` (объяснение кода).
    - [x] `toggleTheme`, `setLanguage`.
    - [x] Безопасная инициализация (`safeParse` localStorage).
- [x] 3.5. **useDiagramStudio (Hook):** Разделить хендлеры `Chat` (не меняет Mermaid код) и `Build` (генерирует/обновляет диаграмму).

## 4. Интеграция и UX
- [x] 4.1. **Dark Mode:** Полная поддержка темной темы (UI + Editor + Mermaid).
- [x] 4.2. **Syntax Highlighting:** Подсветка синтаксиса Mermaid (PrismJS + кастомная грамматика).
- [x] 4.3. **Auto-Connect:** Автоматическое подключение при старте приложения.
- [x] 4.4. **Language Detection:** Авто-определение языка пользователя (RU/EN).

## 5. Доработка и Полировка (Future)
- [x] 5.1. **Автоматический Fix Loop:** Автоматически запускать исправление (до N попыток) после Build при невалидном результате.
- [ ] 5.2. **Стилизация (Style Flow):** Добавить отдельный режим для стилизации диаграммы без изменения структуры.
- [ ] 5.3. **Тесты:** Добавить Unit-тесты для хуков и сервисов.
- [x] 5.4. **Export:** Добавить экспорт диаграммы в PNG/SVG.
- [x] 5.8. **Полный список типов Mermaid:** Расширить типы, UI селектор и docsContextService до полного списка из `mermaid-docs/<version>/syntax/*.md`.
- [x] 5.9. **Контекст Build-доков:** В отдельной вкладке Build Docs табами с чекбоксами управлять файлами документации, включаемыми в Build-промпт.
- [x] 5.10. **Markdown превью:** Рендер Markdown и Mermaid-блоков в Preview.

- [x] 5.5. **Preview Controls:** Zoom/Pan + Fit/Reset в окне рендера.
- [x] 5.6. **History:** Хранение истории шагов (TimeStep) и ревизий диаграммы в IndexedDB.
- [x] 5.7. **Chat Timeline:** Метки "отрисовка диаграммы" в чате и навигация по ним (переход + переключение ревизии).

## 6. История Исправлений
- [x] 6.1. Исправлен "белый экран" (безопасный парсинг localStorage).
- [x] 6.2. Исправлен скачок курсора в редакторе (синхронное обновление state).
- [x] 6.3. Перенесена кнопка выбора языка в панель редактора.
- [x] 6.4. Исправлена синхронизация темы Mermaid при переключении.
