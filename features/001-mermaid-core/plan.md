# План Реализации: Генератор Диаграмм Mermaid (Обновленный)

## 1. Обзор Архитектуры

Система следует клиент-центричной архитектуре с тонким Node.js бэкендом. Основная логика генерации, валидации и управления состоянием находится на клиенте.

```mermaid
graph TD
    Пользователь -->|1. Промпт/Действие| UI(Интерфейс)
    UI -->|2. Обновление State| StateManager(State.js + Pub/Sub)
    StateManager -->|3. Уведомление подписчиков| UI
    UI -->|4. Запуск Workflow| Workflows(Workflows.js)
    Workflows -->|5. Подготовка Промпта| Prompts(Prompts.js)
    Workflows -->|6. Запрос контекста доков| API(Api.js)
    API -->|7. Поиск в документации| NodeServer(Node.js Server)
    Workflows -->|8. Запрос к LLM| API
    API -->|9. Проксирование запроса| LocalProxy(Local cliproxyapi)
    LocalProxy -->|10. Ответ LLM| API
    Workflows -->|11. Валидация| Validator(Validation.js + Mermaid.parse)
    Validator -->|12. Результат (OK/Fail)| Workflows
    Workflows -->|13. Обновление State (Итерация/Стадия)| StateManager
```

## 2. Технический Стек

*   **Фронтенд:** 
    *   HTML5, CSS3.
    *   JavaScript (ES6 Modules).
    *   Mermaid.js (рендеринг и парсинг).
*   **Бэкенд:** 
    *   Node.js (v18+).
    *   Express (веб-сервер).
    *   adm-zip (работа с архивами документации).
    *   node-fetch (HTTP запросы).
*   **Взаимодействие с LLM:** `cliproxyapi` (локальный сервис).

## 3. Структура Модулей Фронтенда

*   **`main.js`:** Точка входа. Инициализация слушателей событий UI, подписка на изменения состояния, связывание компонентов.
*   **`state.js`:** Центральное хранилище состояния (State Store). Реализует паттерн Pub/Sub. Содержит данные о моделях, итерациях, настройках.
*   **`api.js`:** Слой взаимодействия с внешними сервисами (`cliproxyapi` и собственный бэкенд `/docs/search`).
*   **`ui.js`:** Функции для манипуляции DOM (рендер списков, модальные окна, статусы). "Глупые" компоненты, не знающие о бизнес-логике.
*   **`workflows.js`:** Реализация бизнес-процессов (оркестрация): `runStructureFlow` (генерация структуры) и `runStyleFlow` (стилизация). Управляет циклами повторных попыток.
*   **`modelManager.js`:** Логика выбора, фильтрации и сортировки моделей LLM.
*   **`prompts.js`:** Шаблонизатор промптов. Содержит системные и пользовательские промпты для разных этапов и типов диаграмм.
*   **`validation.js`:** Обертка над `mermaid.parse` для проверки корректности кода.
*   **`sanitize.js`:** Утилиты для очистки и нормализации кода Mermaid (удаление markdown-оберток и т.д.).

## 4. Бэкенд (Node.js)

*   **`server.js`:**
    *   Раздача статики из `public/`.
    *   `GET /docs/search`: Эндпоинт поиска по документации.
    *   Автоматическое скачивание и распаковка документации Mermaid с GitHub при старте (если нет локально).
    *   Нормализация поисковых запросов через LLM (опционально).

## 5. Процессы (Workflows)

### 5.1. Генерация Структуры (`runStructureFlow`)
1.  Получение промпта пользователя.
2.  Поиск релевантной документации (через бэкенд).
3.  Формирование промпта (User Prompt + Docs Context).
4.  Вызов LLM (Structure Agent).
5.  Валидация полученного кода.
6.  Если невалидно -> цикл исправлений (Self-correction loop).
7.  Сохранение результата в историю итераций.

### 5.2. Стилизация (`runStyleFlow`)
1.  Берется валидная структура из предыдущего этапа.
2.  Запрашивается контекст документации по стилям.
3.  Формируется промпт для Style Agent.
4.  Вызов LLM.
5.  Валидация + специфичные проверки (запрещенные директивы для определенных типов диаграмм).
6.  Цикл авто-исправления стилей (Fix Style Agent).
7.  Сохранение стилизованной версии.

## 6. Тестирование и Качество

*   **ESLint + Prettier:** Линтинг и форматирование JS кода.
*   **Модульность:** Строгое разделение ответственности позволяет тестировать модули изолированно (в будущем).
*   **Обработка ошибок:** Все асинхронные операции обернуты в try/catch с уведомлением пользователя через UI.