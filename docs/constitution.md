# Конституция mermaid-langgraph

Документ фиксирует обязательные принципы разработки и эксплуатации генератора диаграмм Mermaid. Любые изменения в коде и конфигурации должны соответствовать правилам ниже.

## Миссия продукта

- Генерировать и улучшать диаграммы Mermaid по естественно-языковым промптам или коду пользователя.
- Работать локально через `cliproxyapi`, чтобы пользователь сам контролировал ключи и расход токенов.
- Быть полностью автономным клиентским приложением (Static SPA), не требующим сложного бэкенда.
- Давать понятную обратную связь: статус генерации, история итераций, коды ошибок валидатора.
- Поддерживать все основные типы диаграмм Mermaid (flowchart, sequence, ER, mindmap, pie и др.).

## Архитектура

- **Тип приложения:** Static Single Page Application (SPA).
- **Клиент** (`public/`): Vanilla JS (ES Modules).
    - `main.js`: Инициализация и связывание UI.
    - `controller.js`: Бизнес-логика и оркестрация потоков.
    - `api.js`, `docsManager.js`, `workflows.js`: Сервисные модули.
- **Документация:**
  - Загружается клиентом напрямую из репозитория `mermaid-js/mermaid` через GitHub API.
  - Кэшируется в браузере (`localStorage` / Memory).
  - Поддерживает выбор версий (тегов релизов).
- **LLM Бэкенд:** Внешний локальный сервис `cliproxyapi` (OpenAI compatible). Приложение обращается к нему напрямую через `fetch`.

## Ключевые принципы разработки

1. **Spec-first**: перед работой читать этот документ и актуальные спецификации в `features/`.
2. **Client-side First**: Никакой логики на сервере (кроме раздачи статики). Все вычисления, парсинг и валидация происходят в браузере пользователя.
3. **Двухфазная генерация**:
    - Фаза 1: Структура (Structure Flow). Генерация корректного синтаксиса.
    - Фаза 2: Стиль (Style Flow). Улучшение визуализации без изменения логики.
    - На обоих этапах обязательна валидация через `mermaid.parse()`. При ошибках — автоматический цикл исправлений (Fix Flow).
4. **Умный ввод**: Приложение должно уметь понимать как текстовый промпт ("Нарисуй схему БД"), так и код Mermaid (с ошибками или без).
    - Если введен валидный код -> мгновенный рендер (Live Preview).
    - Если введен невалидный код -> запуск Fix Flow.
    - Тип диаграммы определяется автоматически (Regex + LLM fallback).
5. **Безопасность**: Токены LLM хранятся только в `localStorage` пользователя. CORS запросы к локальному прокси должны быть разрешены на стороне прокси.

## Настройки

- Настройки (URL прокси, токен, модель) хранятся в браузере.
- Версия документации выбирается в UI.

## Качество и тесты

- **Линтинг:** JavaScript/HTML/CSS проверяется через `npm run lint` (ESLint + Prettier).
- **Код:** Чистый, модульный JS без использования тяжелых фреймворков (React/Vue/Angular), чтобы сохранить легкость и прозрачность.
- **Тестирование:** Ручная проверка основных сценариев:
    1. Генерация с нуля.
    2. Вставка валидного кода (мгновенный рендер).
    3. Вставка сломанного кода -> Исправление.
    4. Стилизация.

## Документация и процесс

- Описание проекта и инструкции запуска — в корневом `README.md`.
- История изменений и планы — в папке `features/`.

Соблюдение этих правил гарантирует, что mermaid-langgraph остаётся легким, безопасным и мощным инструментом, работающим прямо из браузера.
