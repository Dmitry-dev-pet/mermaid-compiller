# Конституция mermaid-langgraph (v2.0)

Документ фиксирует обязательные принципы разработки и эксплуатации генератора диаграмм Mermaid. Любые изменения в коде и конфигурации должны соответствовать правилам ниже.

## Миссия продукта

- Генерировать и улучшать диаграммы Mermaid по естественно-языковым промптам или коду пользователя.
- Работать локально через `cliproxyapi` или через облачные провайдеры (OpenRouter), обеспечивая гибкость и контроль расходов.
- Быть современным клиентским приложением (React SPA) с мгновенным откликом и качественным UX.
- Гарантировать валидность кода диаграмм через встроенную проверку и авто-исправление.
- Поддерживать все основные типы диаграмм Mermaid (flowchart, sequence, ER, mindmap, pie и др.).

## Архитектура

- **Тип приложения:** Single Page Application (SPA), собранное с помощью Vite.
- **Стек:** React 19, TypeScript, Tailwind CSS.
- **Структура (`diagram-compiler/`):**
    - `components/`: UI компоненты (презентационные).
    - `hooks/`: Бизнес-логика и управление состоянием.
      - `hooks/core/`: базовые хуки состояния (`useAI`, `useMermaid`, `useLayout`, `useChat`, `useHistory`).
      - `hooks/studio/`: оркестрация и студийные хуки (`useDiagramStudio` и специализированные подхуки).
    - `services/`: Взаимодействие с API, валидация, работа с документацией.
- **Документация:**
  - Загружается локально (параллельный фетчинг) из папки `public/mermaid-docs`.
  - Используется как контекст для LLM при генерации.
- **LLM Бэкенд:** Реализован через паттерн Стратегия (`LLMProviderStrategy`). Поддержка OpenRouter и локального прокси.

## Ключевые принципы разработки

1. **Spec-first**: Перед работой читать спецификации в `features/`.
2. **React Hooks & Patterns**: Вся логика состояния и эффектов должна быть инкапсулирована в хуки. Компоненты должны быть максимально чистыми.
3. **Интеллектуальная генерация**:
    - Чат-режим с анализом намерений пользователя (Analyze / Generate / Fix).
    - Авто-определение языка (RU/EN) и адаптация системных промптов.
    - Очистка ответов LLM от лишнего кода перед показом пользователю.
4. **Валидация и безопасность**:
    - Обязательная проверка синтаксиса через `mermaid.parse()` перед рендером.
    - API-ключи хранятся только в `localStorage` пользователя.
    - История чата/шагов/ревизий диаграмм хранится локально в браузере (IndexedDB); в `localStorage` остаются только настройки.
    - Безопасная инициализация состояния (`safeParse`).
5. **UX First**:
    - Dark Mode "из коробки" (One Dark theme).
    - Подсветка синтаксиса (PrismJS).
    - Мгновенный фидбек (Live Preview).

## Настройки

- Настройки (провайдер, ключи, модель, тема, язык) хранятся в `localStorage` и автоматически подхватываются при старте.
- Приложение должно уметь восстанавливаться после обновления страницы (Auto-connect).

## Качество и тесты

- **Линтинг:** Строгое соблюдение правил ESLint (`npm run lint`).
- **Типизация:** Strict TypeScript. Никаких `any`, если это не обосновано крайней необходимостью (в таких случаях использовать `unknown` с проверкой типов).
- **Стиль:** Tailwind CSS для стилизации. Использование utility-first подхода.

## Документация и процесс

- Описание проекта и инструкции запуска — в `README.md` (внутри `diagram-compiler` и в корне).
- История изменений, планы и задачи — в папке `features/001-mermaid-core/`.

Соблюдение этих правил гарантирует, что mermaid-langgraph остаётся надежным, расширяемым и удобным инструментом для разработчиков.

---

Обновлено: 2025-12-24. Согласовано с текущей реализацией (markdown-навигация, scroll sync, frontmatter config).
