# Mermaid: валидация, рендер, превью и экспорт

## Инициализация

`initializeMermaid(theme)` настраивает Mermaid:

- `startOnLoad: false`.
- `theme`: `default` или `dark`.
- `securityLevel: 'loose'`.

## Валидация

`validateMermaid(code)`:

- Определяет Markdown (`isMarkdownLike`) и в этом случае пропускает валидацию (считается валидным контентом для превью).
- Для Mermaid-кода применяет inline-команды направления/темы/стиля (`applyInlineDirectionCommand`, `applyInlineThemeAndLookCommands`) и вызывает `mermaid.parse()`.
- При успехе помечает статус `valid` и обновляет `lastValidCode`; при ошибке извлекает номер строки.

## Рендеринг

`PreviewColumn` рендерит разными режимами:

- **Mermaid:** перед вызовом `mermaid.render` применяется inline направление/тема/стиль. После рендера монтируется SVG, вызывается `bindFunctions`, включается `svg-pan-zoom`.
- **Markdown:** контент рендерится через `markdown-it`; `code` блоки с `language-mermaid` заменяются на SVG через `mermaid.render`.
- При ошибке рендера показывается оверлей с текстом ошибки; для статуса `invalid` показывается предупреждение вместо SVG.

## Zoom/Pan и fullscreen

- Используется `svg-pan-zoom`; на каждой перерисовке вызываются `resize` + `fit` + `center`.
- Доступны кнопки Zoom In/Out, Fit и fullscreen (на всю ширину трех колонок); zoom отображается в процентах.

## Inline-настройки

- В шапке превью: выбор темы (`theme`), направления (`direction`) и стиля (`look`).
- Выбранные значения добавляются в код как директивы (`%%{theme: ...}%%`, `%%{direction: ...}%%`, `%%{init: { look: ...}}%%`) и сразу учитываются в валидации/рендере.

## Превью промптов

- Вкладки Prompt · Chat / Prompt · Build показывают собранный системный промпт, список файлов документации и список сообщений.
- Отображается оценка токенов (system/messages/total); Markdown рендерится вместе с Mermaid-блоками.
- Переключатель Raw/Redacted показывает полный промпт или версию с сокращенным блоком документации.

## Экспорт

- Кнопки **SVG** и **PNG** доступны, когда есть сгенерированное SVG (не для Markdown режима).
- **SVG:** клонирует текущий SVG, нормализует `viewBox`, опционально добавляет фон и скачивает файл.
- **PNG:** инлайнит внешние `image`/`foreignObject img` и CSS-ресурсы (с таймаутами и лимитами по размеру/количеству), отказывает при `foreignObject` или при оставшихся внешних ссылках. Фон выбирается по текущей теме.
- Ошибки экспорта отображаются рядом с контролами в шапке превью.
