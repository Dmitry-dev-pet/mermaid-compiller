# Архитектура

## Общая схема

Приложение — SPA в папке `diagram-compiler/`. Основная композиция UI собирается в `App.tsx`, а бизнес-логика сосредоточена в хуках и сервисах.

Дополнительно архитектура визуализирована в `docs/c4/`.

Основные уровни:

1. **UI-компоненты** (`diagram-compiler/components`)
   - `Header` — управление провайдером LLM, подключением и темой.
   - `ChatColumn` — история сообщений, выбор типа диаграммы, Chat/Build.
   - `EditorColumn` — редактор Mermaid-кода, Analyze/Fix/Snapshot, язык анализа, вкладки Prompt/Build Docs и вкладки Mermaid-блоков Markdown.
   - `PreviewColumn` — SVG-рендер, zoom/pan, fullscreen.

2. **Хуки** (`diagram-compiler/hooks`)
   - `useDiagramStudio` — единая точка оркестрации состояния и действий.
   - `useAI` — настройки LLM и подключение.
   - `useMermaid` — состояние кода и асинхронная валидация.
   - `useChat` — сообщения и генератор ID.
   - `useHistory` — загрузка и запись истории.
   - `useLayout` — размеры колонок, тема, язык, fullscreen.

3. **Сервисы** (`diagram-compiler/services`)
   - `llmService` — фасад над стратегиями (`OpenRouterStrategy`, `CliproxyStrategy`).
   - `mermaidService` — инициализация Mermaid и валидация.
   - `docsContextService` — загрузка локальных доков Mermaid.
   - `services/history/*` — IndexedDB-хранилище сессий/шагов/ревизий.

## Потоки управления

### Chat

1. Пользователь вводит текст и нажимает Chat.
2. `createChatHandler` собирает сообщения и вызывает LLM (`chat`) без контекста документации.
3. Ответ формирует структурированный intent и сохраняется в истории чата.
4. Код Mermaid не меняется.

### Build

1. Пользователь вводит текст и нажимает Build (или Build без нового текста).
2. Формируется intent (явный промпт, сохраненный intent или последний текст пользователя), добавляется контекст выбранных Build Docs и текущий код диаграммы.
3. Выполняется `generateDiagram`, затем код очищается и валидируется (`mermaid.parse`).
4. Если код невалиден — запускается авто-фикс (до `AUTO_FIX_MAX_ATTEMPTS`).
5. Записывается шаг истории и ревизия диаграммы (если код изменился).

### Fix

1. Запрос `fixDiagram` с кодом и сообщением ошибки.
2. Пытается исправить до `AUTO_FIX_MAX_ATTEMPTS`.
3. Если исправление дало новый код — создается ревизия.

### Analyze

1. Отправляет текущий код в LLM.
2. Добавляет объяснение в чат (код не меняется).

### Snapshot (Manual edit)

1. Пользователь фиксирует текущий код кнопкой Snapshot.
2. Создается шаг `manual_edit` и новая ревизия.

## Источник правды состояния

- **Mermaid-код**: `useMermaid`.
- **UI и layout**: `useLayout`.
- **LLM и соединение**: `useAI`.
- **История**: `useHistory`.
