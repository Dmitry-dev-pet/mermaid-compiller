# Архитектура

## Общая схема

Приложение — SPA в папке `diagram-compiler/`. Основная композиция UI собирается в `App.tsx`, а бизнес-логика сосредоточена в хуках и сервисах.

Дополнительно архитектура визуализирована в `docs/c4/`.

Основные уровни:

1. **UI-компоненты** (`diagram-compiler/components`)
   - `Header` — управление провайдером LLM, подключением и темой.
   - `ChatColumn` — история сообщений, выбор типа диаграммы, Chat/Build.
   - `EditorColumn` — редактор Mermaid-кода, Run/Fix/Analyze, язык.
   - `PreviewColumn` — SVG-рендер, zoom/pan, fullscreen.

2. **Хуки** (`diagram-compiler/hooks`)
   - `useDiagramStudio` — единая точка оркестрации состояния и действий.
   - `useAI` — настройки LLM и подключение.
   - `useMermaid` — состояние кода и асинхронная валидация.
   - `useChat` — сообщения и генератор ID.
   - `useHistory` — загрузка и запись истории.
   - `useLayout` — размеры колонок, тема, язык, fullscreen.

3. **Сервисы** (`diagram-compiler/services`)
   - `llmService` — фасад над стратегиями (`OpenRouterStrategy`, `CliproxyStrategy`).
   - `mermaidService` — инициализация Mermaid и валидация.
   - `docsContextService` — загрузка локальных доков Mermaid.
   - `services/history/*` — IndexedDB-хранилище сессий/шагов/ревизий.

## Потоки управления

### Chat

1. Пользователь вводит текст и нажимает Chat.
2. `createChatHandler` собирает сообщения, загружает docs context.
3. Запрос уходит в LLM (`chat`), ответ добавляется в историю чата.
4. Код Mermaid не меняется.

### Build

1. Пользователь вводит текст и нажимает Build (или Build без нового текста).
2. Готовится «summary before», затем запрос `generateDiagram`.
3. Полученный код очищается, валидируется (`mermaid.parse`).
4. Если код невалиден — запускается авто-фикс (до `AUTO_FIX_MAX_ATTEMPTS`).
5. Записывается шаг истории и ревизия диаграммы (если код изменился).

### Run / Recompile

1. Генерация диаграммы на основании истории чата без специального промпта.
2. Валидируется и записывается как новая ревизия.

### Fix

1. Запрос `fixDiagram` с кодом и сообщением ошибки.
2. Пытается исправить до `AUTO_FIX_MAX_ATTEMPTS`.
3. Если исправление дало новый код — создается ревизия.

### Analyze

1. Отправляет текущий код в LLM.
2. Добавляет объяснение в чат (код не меняется).

## Источник правды состояния

- **Mermaid-код**: `useMermaid`.
- **UI и layout**: `useLayout`.
- **LLM и соединение**: `useAI`.
- **История**: `useHistory`.
