# Пользовательские сценарии и UX

## Основной сценарий

1. Выберите тип диаграммы в левой колонке (Chat) — откроется вкладка **Build Docs** с табами файлов и чекбоксами (код не перезаписывается).
2. Введите запрос и нажмите **Chat** — получите структурированный intent без Mermaid-кода.
3. Нажмите **Build** — генерация/обновление Mermaid-кода на основе intent + текущей диаграммы + документации.
4. При ошибках используйте **Fix** (для активной диаграммы или активного Mermaid-блока), либо отредактируйте код вручную.
5. Для ручной фиксации состояния используйте **Snapshot** в панели редактора.

## Диалоговые режимы

- **Chat**: текстовый ответ (intent). Код не меняется, контекст документации не добавляется, язык определяется автоматически при выборе `Auto`.
- **Build**: генерирует/обновляет Mermaid-код. Если явного промпта нет, берется последний intent/запрос пользователя; требуются валидный intent или последний текст. Контекст документации берется из отмеченных файлов Build Docs.
- **Analyze**: объяснение структуры диаграммы.
- **Fix**: исправление синтаксиса (до `AUTO_FIX_MAX_ATTEMPTS`) для активной диаграммы, включая Mermaid-блок в Markdown.

## Горячие клавиши

- Enter — отправить Chat.
- Ctrl/Cmd + Enter — Build.

## Язык ответов

- Выбор языка применяется только к **Analyze** (Auto / EN / RU).
- В режиме Auto язык определяется по последнему пользовательскому вводу.

## Типы диаграмм

Доступны все типы из локальной документации: architecture, block, c4, class, er, flowchart, gantt, gitGraph, kanban, mindmap, packet, pie, quadrantChart, radar, requirementDiagram, sankey, sequence, state, timeline, treemap, userJourney, xychart, zenuml.

- При смене типа загружаются файлы документации (тип + общие) для Build Docs.
- Тип влияет на контекст документации и системные инструкции LLM в Build.

## История и навигация

- Все шаги (Chat/Build/Fix/Analyze/Snapshot) сохраняются.
- В чате отображаются метки «Diagram renders» — это шаги, где создана новая ревизия (Build/Fix/Recompile/Snapshot).
- По клику на метку происходит переход к соответствующему шагу и переключение ревизии.

## Превью

- SVG рендерится через Mermaid API; Markdown режим рендерит текст и Mermaid-блоки внутри Markdown.
- Невалидные Mermaid-блоки в Markdown заменяются встроенным сообщением об ошибке на месте блока.
- Доступны zoom/pan, fit и fullscreen (на всю ширину трех колонок).
- Inline-контролы в шапке: тема, направление и стиль (look) добавляются в код как директивы.
- Вкладки Prompt · Chat / Prompt · Build / Prompt · Analyze / Prompt · Fix показывают собранный системный промпт, список файлов документации и оценку токенов.
- Переключатель Raw/Redacted показывает полный промпт или версию без полного текста доков.
- Вкладка Build Docs показывает содержимое выбранного файла и рендерит Mermaid-блоки.

## Экспорт

- В превью доступны кнопки **SVG** и **PNG**.
- SVG сохраняется напрямую из текущего `svg`.
- PNG инлайнит внешние ресурсы, отказывает при `foreignObject`/таинтед canvas или слишком крупных/многочисленных ресурсах (в этом случае предлагается экспортировать SVG).
- Фон PNG зависит от текущей темы (dark/light).
