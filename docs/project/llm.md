# LLM-интеграция

## Провайдеры

Два провайдера (паттерн «Стратегия»):

- **OpenRouter** (`OpenRouterStrategy`).
- **Cliproxy** (`CliproxyStrategy`) — локальный или кастомный прокси с OpenAI-совместимым API.

Выбор провайдера выполняется в `Header`; при смене провайдера подтягивается сохраненная модель для него.

## Настройки подключения

Хранятся в `localStorage`:

- `openRouterKey` — API ключ OpenRouter.
- `proxyEndpoint` — URL локального прокси.
- `proxyKey` — ключ прокси (если требуется).
- `selectedModelIdByProvider` — выбранная модель для каждого провайдера.
- `filtersByProvider` — фильтры для OpenRouter/Cliproxy (vendor, free-only, tested-only, min context).

## Получение моделей

- **OpenRouter:** `GET {endpoint}/v1/models` (требуется ключ). Вендор определяется эвристикой по id/name.
- **Cliproxy:** последовательная проверка `/v1/models`, `/models`, `/api/models`; вендор так же выводится из id/name.
- Фильтры применяются по провайдеру (free/tested/min context/vendor). Если после фильтра осталась одна модель, она выбирается автоматически.

## Системные промпты и контекст

Промпты собираются в `services/llm/prompts.ts`:

- Режимы: `generate`, `fix`, `chat`, `analyze`.
- Язык: RU/EN (Auto → определяется по последнему пользовательскому вводу/intent). Ручной выбор языка применяется только для Analyze.
- Для Build и Fix контекст Mermaid-документации добавляется полностью (без усечений) и включает файлы выбранного типа + общие синтаксис/конфигурацию.
- Выбор файлов для Build-контекста управляется чекбоксами в Build Docs.
- Chat работает без контекста документации и возвращает структурированный intent (Summary/Requirements/Constraints/Open questions).
- Build принимает intent (явный промпт или сохраненный после Chat); текущий код диаграммы добавляется отдельным сообщением.

## Контекст текущей диаграммы и intent

- Если код диаграммы есть, он передается как отдельное сообщение в Build/Fix/Analyze для учета текущего состояния.
- При Markdown с Mermaid-блоками используется код активного блока.
- Intent сохраняется после Chat/Build и используется по умолчанию для следующего Build.

## Поведение режимов

- **Chat** — текстовый intent, без генерации кода и без контекста документации.
- **Build** — генерация Mermaid, обязательная валидация + авто-фикс; в логах/ошибках указывается используемая модель.
- **Fix** — исправление Mermaid-синтаксиса по сообщению ошибки (до `AUTO_FIX_MAX_ATTEMPTS`).
- **Analyze** — объяснение диаграммы без генерации кода.

## Превью промптов

- Вкладки Prompt · Chat / Prompt · Build / Prompt · Analyze / Prompt · Fix показывают собранный системный промпт, список файлов документации и финальные сообщения, а также оценку токенов (system/messages/total).
- Превью обновляется при вводе, смене типа диаграммы и обновлении истории.
- Переключатель Raw/Redacted показывает полный системный промпт или версию с редактированным блоком документации.
