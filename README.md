# mermaid-langgraph

Генератор диаграмм Mermaid, который принимает промпты на естественном языке, обращается к локальному cliproxyapi и выдаёт валидный код диаграмм с мгновенной визуализацией и историей итераций.

## Основные возможности

- Двухфазная генерация: сначала строим структуру диаграммы, затем отдельным вызовом улучшаем стилизацию.
- Жёсткая валидация через `mermaid.parse()` и автоматический цикл исправлений (до 5 попыток) при ошибках синтаксиса.
- Выбор типа диаграммы (flow, sequence, ER, mindmap, pie, gitgraph и т.д.) и фильтрация моделей прямо в UI.
- Рендеринг текущего варианта, история всех итераций и отдельные модальные окна с кодом, промптами и контекстом.
- Локальный поиск в официальной документации Mermaid на основе ключевых слов диаграммы.

## Требования

- Для запуска приложения требуется любой статический веб-сервер (например, `npx serve` или `python -m http.server`).
- Node.js 18+ (для установки зависимостей и запуска ESLint/Prettier).
- Рабочий экземпляр `cliproxyapi` (совместимый с OpenAI API), доступный локально.

## Быстрый старт

1. Установите зависимости для линтера:
   ```bash
   npm install
   ```
2. Запустите статический веб-сервер в папке `public`:
   ```bash
   # Например, с помощью npx serve (потребуется установка: npm install -g serve)
   npx serve public
   # Или встроенный в Python сервер
   python3 -m http.server 8000 --directory public
   ```
   По умолчанию приложение будет доступно по адресу, указанному сервером (например, `http://localhost:5000` для `npx serve` или `http://localhost:8000` для Python).
3. Убедитесь, что cliproxyapi слушает `http://localhost:8317` или задайте другой URL в шапке UI.

## Рабочий процесс

1. **Выбор модели и диаграммы.** UI подтягивает список моделей из cliproxyapi, позволяет отфильтровать по вендору и выбрать целевой тип диаграммы.
2. **Структурная генерация.** Первый запрос к LLM строит структуру диаграммы. Код обязательно проходит `mermaid.parse()`. При ошибке запускается до пяти попыток исправления.
3. **Стилистическая итерация.** После успешной структуры запускается отдельный запрос, который меняет только оформление (themes, classDef, директивы init). Есть отдельный цикл фикса для стиля.
4. **История.** Каждая итерация сохраняет промпт, контекст документации, код и итоговый рендер. Можно повторно открыть любую итерацию и посмотреть исходные данные в модалках.
5. **Документация.** Перед обращением к LLM система вытягивает сниппеты из локальной документации Mermaid (`/docs/search`) и добавляет их к промпту.

## Документация Mermaid

Приложение напрямую загружает необходимую документацию из репозитория `mermaid-js/mermaid` на GitHub. Данные кэшируются в браузере.

## Конфигурация

| Переменная | Назначение |
| --- | --- |
| `CLIPROXY_BASE_URL` | Базовый URL локальной прокси (по умолчанию `http://localhost:8317`). |
| `CLIPROXY_API_KEY` | Токен для прокси. UI по умолчанию использует `test`. |
| `CLIPROXY_NORMALIZER_MODEL` | Модель для нормализации текстовых запросов документации. |

## Линтинг и проверка качества

- **JavaScript/CSS/HTML:** `npm run lint` (ESLint + Prettier) по каталогу `public/`.
- **Документация:** держите `README.md` и `docs/constitution.md` в синхронизации с фактическим поведением приложения.

## Полезные файлы

- `docs/constitution.md` — краткая конституция проекта и правила разработки.
- `features/001-mermaid-core/spec.md` — продуктовая спецификация.
- `features/001-mermaid-core/plan.md` — архитектурный план.
- `features/001-mermaid-core/tasks.md` — чек-лист реализуемых задач.
- `legacy_server.js` — предыдущая серверная реализация.

Эти документы образуют единый источник правды для новых изменений. Перед редактированием кода обязательно перечитайте их, чтобы не расходиться с актуальными требованиями.
